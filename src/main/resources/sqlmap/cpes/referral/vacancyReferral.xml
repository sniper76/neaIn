<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="vacancyReferral">

	
	<sql id="VacancyReferralReqList">
		SELECT A.VACANCY_SEQ
		      ,A.COMPNY_SEQ
		      ,FN_GET_COMPNY_NM(A.COMPNY_SEQ,#{lang}) AS COMPNY_NM
		      ,FN_GET_COMMON_NM('EMPLOY_FORM_CD',A.EMPLOY_FORM_CD, #{lang}) AS EMPLOY_FORM_CD
		      ,A.VACANCY_TITLE
		      ,A.MNGER_NM
		      ,A.MNGER_CELL
		      ,A.MNGER_EMAIL
		      ,FN_GET_BASE_DATE_CHAR(A.END_DT, #{lang}) AS END_DT
		      ,CASE WHEN #{lang} = 'kh'
		            THEN C.JC_KH
		            ELSE C.JC_EN
		            END  AS JC_NM
		      ,C.JC_CD
		      ,FN_GET_COMMON_NM('VACANCY_STS_CD',A.VACANCY_STS_CD, #{lang}) AS VACANCY_STS_CD
		      ,A.RECRUMT_DIFFCLT_YN
		      ,A.JC_AGREE_YN
		      ,A.REG_DT
		FROM CPES_VACANCY A JOIN CPES_COMPNY B
		                      ON A.COMPNY_SEQ = B.COMPNY_SEQ
		                    LEFT OUTER JOIN CPES_JOB_CENTER C
		                      ON A.JC_CD = C.JC_CD
		                     AND C.USE_YN = 'Y'
		
	</sql>
	
	<sql id="whereVacancyReferral">
            A.RECRUMT_DIFFCLT_YN = 'Y'
  			AND A.JC_AGREE_YN = 'Y'
            <!-- keyword search 1:user Nm, 2:cv title, 3:phone number-->
            <if test='keyword != null and keyword != ""'>
	            <if test='keywordSel == "1"'> 
					AND A.COMPNY_NM LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "2"'> 
					AND A.VACANCY_TITLE LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "3"'> 
					AND A.MNGER_CELL LIKE CONCAT('%',#{keyword},'%')
				</if>
			</if>
			<!-- keyword search -->
			
            <if test="@org.apache.commons.lang.StringUtils@isNotBlank(jcCd)">
					AND A.JC_CD = #{jcCd}
			</if>
			<if test="@org.apache.commons.lang.StringUtils@isNotBlank(employFormCd)">
					AND A.EMPLOY_FORM_CD = #{employFormCd}
			</if>
			<if test="@org.apache.commons.lang.StringUtils@isNotBlank(vacancyStsCd)">
					AND A.VACANCY_STS_CD = #{vacancyStsCd}
			</if>
			
			<if test="startDate != null and startDate != ''">
			<![CDATA[
			AND A.REG_DT	>= FN_GET_STR_TO_DATE(#{startDate}, 'S')
			]]>
			</if>
			<if test="endDate != null and endDate != ''">
			<![CDATA[			
			AND A.REG_DT	<= FN_GET_STR_TO_DATE(#{endDate}, 'E')
			]]>
			</if>
			
	</sql>
	
	
	<select id="selectVacancyReferralReqList" resultType="VacancyReferralBean" parameterType="VacancyReferralBean">
		SELECT 
			 A.*
			,${recordsTotal} - ((${pageNo} - 1) * ${length}) - (@ROWNUM:=@ROWNUM+1) + 1 AS ROW_NUM
		FROM
        	  (
        	  	SELECT A.*
        	    FROM(
        	    	<include refid="VacancyReferralReqList"/>
        	    ) A			
         <where>
            <include refid="whereVacancyReferral"/>
		</where>
		<choose>
           <when test="@org.apache.commons.lang.StringUtils@isNotBlank(orderColumn)">
          	ORDER BY ${orderColumn} ${orderColumnSort}
          </when>
          <otherwise>
          	ORDER BY A.REG_DT DESC
          </otherwise>
        </choose>
		) A,
		(SELECT @ROWNUM := 1) B
		
        LIMIT ${start} , ${length}
    </select>

	<select id="selectVacancyReferralTotalCount" parameterType="VacancyReferralBean" resultType="int">
		SELECT 
			COUNT(*) AS totalCount 
		FROM 
			(SELECT A.*
        	    FROM(
        	    	<include refid="VacancyReferralReqList"/>
        	    ) A	
		<where>
			<include refid="whereVacancyReferral"/>		
		</where>
		) A
	</select>
	
	<select id="selectJcList" resultType="JobCenterBean" parameterType="VacancyReferralBean">
		SELECT 
			JC_CD
		  , CASE WHEN #{lang} = 'kh'
		         THEN JC_KH
		         ELSE JC_EN
		         END AS JC_NM
		  , JC_EN
		  , JC_KH
		  , ADDR_EN
		  , ADDR_KH
		  , TEL1
		  , TEL2
		  , TEL3
		  , TEL4
		  , EMAIL
		  , FACEBOOK
		  , WEBSITE
		  , FILE_GRP_SEQ
		  , ADDR_CD
		  , EXPLN_EN
		  , LNGTD
		  , LATTD
		  , EXPLN_KH
		  , REG_USER_SEQ
		  , REG_DT
		  , MOD_USER_SEQ
		  , MOD_DT
		FROM CPES_JOB_CENTER
		<if test='user.neaJcDivCd == "NJD0000000002"'>
			<where>
				JC_CD = #{user.jcCd}
			  AND USE_YN = 'Y'
			</where>
		</if>
	</select>
	
	<select id="selectReferralCmpnySearchList" resultType="UserCmpnyBean" parameterType="VacancyReferralBean">
		SELECT A.*
		FROM (
				SELECT A.COMPNY_SEQ
				      ,FN_GET_COMPNY_NM(A.COMPNY_SEQ, #{lang}) AS COMPNY_NM
				      ,B.REG_NUM
				      ,A.MNGER_NM
				      ,A.MNGER_CELL
				      ,A.MNGER_EMAIL
				      ,C.JC_CD
				      ,B.COMPNY_NM_KH
				      ,B.COMPNY_NM_EN
				FROM CPES_VACANCY A JOIN CPES_COMPNY B
				                      ON A.COMPNY_SEQ = B.COMPNY_SEQ
				                    LEFT OUTER JOIN CPES_JOB_CENTER C
				                      ON A.JC_CD = C.JC_CD
				                     AND C.USE_YN = 'Y'
				WHERE A.JC_AGREE_YN = 'Y'
		) A
		<where>
		  1=1
		  <!-- keyword search 1:COMPNY_NM, 2:REG_NUM, 3:MNGER_CELL, 4:MNGER_NM, 5:MNGER_EMAIL-->
            <if test='keyword != null and keyword != ""'>
	            <if test='keywordSel == "1"'> 
					AND A.COMPNY_NM LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "2"'> 
					AND A.REG_NUM LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "3"'> 
					AND A.MNGER_CELL LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "4"'> 
					AND A.MNGER_NM LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "5"'> 
					AND A.MNGER_EMAIL LIKE CONCAT('%',#{keyword},'%')
				</if>
			</if>
			<!-- keyword search -->
			
		  <if test='user.neaJcDivCd == "NJD0000000002"'>
				AND A.JC_CD = #{user.jcCd}
		  </if>
		</where>
	</select>
	    
</mapper>
