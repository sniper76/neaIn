<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jobskReferral">

	
	<sql id="JobskReferralReqList">
		SELECT A.RESUME_SEQ
		      ,F.JOBSK_REQ_SEQ
		      ,A.USER_SEQ
		      ,FN_GET_USER_NM_BY_USER_SEQ(A.USER_SEQ,#{lang}) AS USER_NM
		      ,A.RESUME_TITLE
		      ,CASE WHEN A.NOW_WORK_YN = 'Y'
		            THEN 'Working'
		            ELSE 'Inoccupation'
		            END NOW_WORK_STS
		      ,FN_GET_COMMON_NM('USER_AUTH_CD',B.USER_AUTH_CD, #{lang}) AS USER_AUTH_CD
		      ,C.CELL
		      ,D.EMAIL_ADDR
		      ,FN_GET_BASE_DATE_CHAR(A.MOD_DT, #{lang}) AS MOD_DT
		      ,CASE WHEN #{lang} = 'kh'
		            THEN E.JC_KH
		            ELSE E.JC_EN
		            END  AS JC_NM
		      ,FN_GET_COMMON_NM('JOBSK_STS_CD',B.JOBSK_STS_CD, #{lang}) AS JOBSK_STS_CD
		      ,A.URGENT_JOBSEEK_YN
		      ,A.USE_YN
		      ,A.REG_DT
		      ,A.JC_CD
		      ,A.NOW_WORK_YN
		FROM CPES_RESUME A JOIN CPES_USER B
		                     ON A.USER_SEQ = B.USER_SEQ
		                   LEFT OUTER JOIN CPES_RESUME_CELL C
		                     ON A.RESUME_SEQ = C.RESUME_SEQ
		                   LEFT OUTER JOIN CPES_RESUME_EMAIL D
		                     ON A.RESUME_SEQ = D.RESUME_SEQ
		                   LEFT OUTER JOIN CPES_JOB_CENTER E
		                     ON A.JC_CD = E.JC_CD
		                   JOIN CPES_JOBSK_REQ F
		                     ON A.RESUME_SEQ = F.RESUME_SEQ
		                    AND F.DEL_YN = 'N'
		                    AND F.JC_AGREE_STS_CD = 'JAS0000000001'
		
	</sql>
	
	<sql id="whereJobskReferral">
            A.URGENT_JOBSEEK_YN = 'Y'
            AND A.USE_YN = 'Y'
            <!-- keyword search 1:user Nm, 2:cv title, 3:phone number-->
            <if test='keyword != null and keyword != ""'>
	            <if test='keywordSel == "1"'> 
					AND A.USER_NM LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "2"'> 
					AND A.RESUME_TITLE LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "3"'> 
					AND A.CELL LIKE CONCAT('%',#{keyword},'%')
				</if>
			</if>
			<!-- keyword search -->
			
            <if test="@org.apache.commons.lang.StringUtils@isNotBlank(jcCd)">
					AND A.JC_CD = #{jcCd}
			</if>
			<if test="@org.apache.commons.lang.StringUtils@isNotBlank(userAuthCd)">
					AND A.USER_AUTH_CD = #{userAuthCd}
			</if>
			<if test="@org.apache.commons.lang.StringUtils@isNotBlank(nowWorkSts)">
					AND A.NOW_WORK_YN = #{nowWorkSts}
			</if>
			
			<if test="startDate != null and startDate != ''">
			<![CDATA[
			AND A.REG_DT	>= FN_GET_STR_TO_DATE(#{startDate}, 'S')
			]]>
			</if>
			<if test="endDate != null and endDate != ''">
			<![CDATA[			
			AND A.REG_DT	<= FN_GET_STR_TO_DATE(#{endDate}, 'E')
			]]>
			</if>
			
	</sql>
	
	
	<select id="selectJobskReferralReqList" resultType="JobskReferralBean" parameterType="JobskReferralBean">
		SELECT 
			 A.*
			,${recordsTotal} - ((${pageNo} - 1) * ${length}) - (@ROWNUM:=@ROWNUM+1) + 1 AS ROW_NUM
		FROM
        	  (SELECT A.*
        	    FROM(
        	    	<include refid="JobskReferralReqList"/>
        	    ) A	
        	  		
         <where>
            <include refid="whereJobskReferral"/>
		</where>
		<choose>
           <when test="@org.apache.commons.lang.StringUtils@isNotBlank(orderColumn)">
          	ORDER BY ${orderColumn} ${orderColumnSort}
          </when>
          <otherwise>
          	ORDER BY A.REG_DT DESC
          </otherwise>
        </choose>
		) A,
		(SELECT @ROWNUM := 0) B
		
        LIMIT ${start} , ${length}
    </select>

	<select id="selectJobskReferralTotalCount" parameterType="JobskReferralBean" resultType="int">
		SELECT 
			COUNT(*) AS totalCount 
		FROM 
			(SELECT A.*
        	    FROM(
        	    	<include refid="JobskReferralReqList"/>
        	    ) A	
		<where>
			<include refid="whereJobskReferral"/>		
		</where>
		) A
	</select>
	
	<select id="selectJcList" resultType="JobCenterBean" parameterType="JobskReferralBean">
		SELECT 
			JC_CD
		  , CASE WHEN #{lang} = 'kh'
		         THEN JC_KH
		         ELSE JC_EN
		         END AS JC_NM
		  , JC_EN
		  , JC_KH
		  , ADDR_EN
		  , ADDR_KH
		  , TEL1
		  , TEL2
		  , TEL3
		  , TEL4
		  , EMAIL
		  , FACEBOOK
		  , WEBSITE
		  , FILE_GRP_SEQ
		  , ADDR_CD
		  , EXPLN_EN
		  , LNGTD
		  , LATTD
		  , EXPLN_KH
		  , REG_USER_SEQ
		  , REG_DT
		  , MOD_USER_SEQ
		  , MOD_DT
		FROM CPES_JOB_CENTER
		<if test='user.neaJcDivCd == "NJD0000000002"'>
			<where>
				JC_CD = #{user.jcCd}
			  AND USE_YN = 'Y'
			</where>
		</if>
	</select>
	
	<select id="selectReferralUserSearchList" resultType="UserBean" parameterType="JobskReferralBean">
		SELECT A.*
		FROM ( 
			SELECT D.USER_SEQ
			      ,FN_GET_USER_NM_BY_USER_SEQ(D.USER_SEQ,#{lang}) AS USER_NM
			      ,FN_GET_COMMON_NM('USER_AUTH_CD',D.USER_AUTH_CD, #{lang}) AS USER_AUTH_CD
			      ,(SELECT CPES_RESUME_CELL.CELL FROM CPES_RESUME_CELL WHERE CPES_RESUME_CELL.RESUME_SEQ = B.RESUME_SEQ) AS USER_CELL
			      ,(SELECT CPES_RESUME_EMAIL.EMAIL_ADDR FROM CPES_RESUME_EMAIL WHERE CPES_RESUME_EMAIL.RESUME_SEQ = B.RESUME_SEQ) AS USER_EMAIL
			FROM CPES_JOBSK_REQ A JOIN CPES_RESUME B
			                        ON A.RESUME_SEQ = B.RESUME_SEQ
			                       AND B.PRI_RESUME_YN = 'Y'
			                      JOIN CPES_JOB_CENTER C
			                        ON B.JC_CD = C.JC_CD
			                      JOIN CPES_USER D
			                        ON B.USER_SEQ = D.USER_SEQ
			                       AND D.USE_YN = 'Y'
			WHERE A.JC_AGREE_STS_CD = 'JAS0000000001'
			
		) A
		<where>
		  1=1
		  <!-- keyword search 1:user Nm, 2:cv title, 3:phone number-->
            <if test='keyword != null and keyword != ""'>
	            <if test='keywordSel == "1"'> 
					AND USER_NM LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "2"'> 
					AND A.RESUME_TITLE LIKE CONCAT('%',#{keyword},'%')
				</if>
				<if test='keywordSel == "3"'> 
					AND C.CELL LIKE CONCAT('%',#{keyword},'%')
				</if>
			</if>
			<!-- keyword search -->
			
		  <if test='user.neaJcDivCd == "NJD0000000002"'>
				AND C.JC_CD = #{user.jcCd}
		  </if>
		</where>
		GROUP BY A.USER_SEQ
	</select>
	    
</mapper>
