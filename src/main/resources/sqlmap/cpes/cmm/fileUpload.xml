<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fileUpload">
	
	<select id="getAttachGroupId" resultType="int">

			SELECT IFNULL(MAX(ATTACH_GROUP_ID)+1, 1) FROM CM_ATTACH_FILES

	</select>

    <insert id="setFileInFst" parameterType="FileBean">
    	INSERT
		  INTO CM_ATTACH_FILES
	       (   ATTACH_GROUP_ID
	          ,ORIGINAL_NM
	          ,SAVE_NM
	          ,SAVE_FILE_PATH
	          ,FILE_EXTENSION
	          ,FILE_SIZE
	          ,REG_ID
	          ,UPD_ID
	       )
	       values
	       (   #{attachGroupId}
	          ,#{originalNm}
	          ,#{saveNm}
	          ,#{saveFilePath}
	          ,#{fileExtension}
	          ,#{fileSize}
	          ,#{regId}
	          ,#{updId}
	       )
	       
		<selectKey keyProperty="attachId" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<select id="getFileGroupInfo" parameterType="FileBean" resultType="FileBean">
	      SELECT   ATTACH_ID       AS attachId       /*파일_일련번호*/
			     , ATTACH_GROUP_ID AS attachGroupId  /*파일_그룹_일련번호*/
			     , ORIGINAL_NM     AS originalNm     /*논리명*/
			     , SAVE_NM         AS saveNm         /*물리명*/
			     , SAVE_FILE_PATH  AS saveFilePath   /*파일저장경*/
			     , FILE_EXTENSION  AS fileExtension  /*파일확장자*/
			     , FILE_SIZE       AS fileSize       /*파일사이즈*/
			FROM   CM_ATTACH_FILES
           WHERE   ATTACH_GROUP_ID = #{attachGroupId}
	  		 AND   DEL_YN = 'N'
	</select>

  	<update id="setAttachFileDel" parameterType="int">
		UPDATE CM_ATTACH_FILES
		   SET DEL_YN = 'Y'
		     , UPD_ID = #{updId}
		 WHERE ATTACH_ID = #{attachId}
	</update>

	<update id="setAttachFileAllDel" parameterType="int">
		UPDATE CM_ATTACH_FILES
		   SET DEL_YN = 'Y'
		     , UPD_ID = #{updId}
		 WHERE ATTACH_GROUP_ID = #{attachGroupId}
	</update>

	<select id="getAttachFileInfo" parameterType="int" resultType="FileBean">
	     SELECT    ATTACH_ID       AS attachId       /*파일_일련번호*/
			     , ATTACH_GROUP_ID AS attachGroupId  /*파일_그룹_일련번호*/
			     , ORIGINAL_NM     AS originalNm     /*논리명*/
			     , SAVE_NM         AS saveNm         /*물리명*/
			     , SAVE_FILE_PATH  AS saveFilePath   /*파일저장경*/
			     , FILE_EXTENSION  AS fileExtension  /*파일확장자*/
			     , FILE_SIZE       AS fileSize       /*파일사이즈*/
			FROM   CM_ATTACH_FILES
           WHERE   ATTACH_ID = #{attachId}
	  		 AND   DEL_YN = 'N'
	</select>
	
	<select id="selectAttachFileList" parameterType="FileBean" resultType="FileBean">
		SELECT
			FILE_SEQ,
			FILE_GRP_SEQ,
			ORIGINAL_NM,
			SAVE_NM,
			SAVE_FILE_PATH,
			FILE_EXTENSION,
			FILE_SIZE
		FROM
			CPES_ATTACH_FILES
		WHERE
			FILE_GRP_SEQ = #{fileGrpSeq}
	</select>

	<select id="selectAttachFileDtl" parameterType="FileBean" resultType="FileBean">
		SELECT
			FILE_SEQ,
			FILE_GRP_SEQ,
			ORIGINAL_NM,
			SAVE_NM,
			SAVE_FILE_PATH,
			FILE_EXTENSION,
			FILE_SIZE
		FROM
			CPES_ATTACH_FILES
		WHERE
			FILE_SEQ = #{fileSeq}
	</select>

	<insert id="insertAttachFile" parameterType="BulletinBean">
		INSERT INTO CPES_ATTACH_FILES (
			FILE_SEQ,
			FILE_GRP_SEQ,
			ORIGINAL_NM,
			SAVE_NM,
			SAVE_FILE_PATH,
			FILE_EXTENSION,
			FILE_SIZE,
			REG_USER_SEQ,
			REG_DT
		) VALUES (
			#{fileSeq},
			#{fileGrpSeq},
			#{originalNm},
			#{saveNm},
			#{saveFilePath},
			#{fileExtension},
			#{fileSize},
			#{user.userSeq},
			NOW()
		)
	</insert>		
		
	<update id="deleteAttachFile" parameterType="FileBean">
		DELETE FROM 
			CPES_ATTACH_FILES
		<where>
			<choose>
				<when test="@org.apache.commons.lang.StringUtils@isNotBlank(fileGrpSeq)">
					FILE_GRP_SEQ = #{fileGrpSeq}
				</when>
				<otherwise>
					FILE_SEQ = #{fileSeq}
				</otherwise>
			</choose>
		</where> 
	</update>
	
</mapper>
