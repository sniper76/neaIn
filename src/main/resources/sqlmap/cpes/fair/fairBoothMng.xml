<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fairBoothMng">

	<select id="selectUUID" resultType="java.lang.String" >
		SELECT REPLACE(UUID(),'-','') AS uuid FROM DUAL
	</select>

	<sql id="selectBoothRegColumn">
		A.BOOTH_SEQ,
		A.FAIR_SEQ,
		A.COMPNY_INSTT_SEQ,
		A.COMPNY_INSTT_DIV_CD,
		A.BOOTH_NM,
		A.BOOTH_FEE,
		A.BOOTH_REQ_DT,
		A.BOOTH_CANCEL_REQ_DT,
		A.BOOTH_STS_CD,
		A.USE_YN,
		A.JC_CD,
		A.JC_USER_SEQ,
		A.REG_USER_SEQ,
		A.REG_DT
	</sql>
	<sql id="whereBoothReg">
		AND B.DEL_YN != 'Y'
	</sql>
	
	<select id="selectBoothRegList" resultType="FairBoothMngBean" parameterType="FairBoothMngBean">
		SELECT 
			<include refid="selectBoothRegColumn"/>
		FROM
			CPES_FAIR_BOOTH A
		JOIN
			CPES_FAIR_MST B
		ON
			A.FAIR_SEQ = B.FAIR_SEQ
		<where>
			AND A.FAIR_SEQ = #{fairSeq}
			AND B.DEL_YN != 'Y'
		</where>
	</select>
	
	<sql id="selectBoothReqMngColumn">
		A.BOOTH_SEQ,
		A.FAIR_SEQ,
		A.COMPNY_INSTT_SEQ,
		A.COMPNY_INSTT_DIV_CD,
		A.BOOTH_NM,
		A.BOOTH_FEE,
		A.BOOTH_REQ_DT,
		A.BOOTH_CANCEL_REQ_DT,
		A.BOOTH_STS_CD,
		A.USE_YN,
		A.JC_CD,
		A.JC_USER_SEQ,
		A.REG_USER_SEQ,
		A.REG_DT,
		( CASE 
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN FN_GET_COMPNY_NM(A.COMPNY_INSTT_SEQ, #{lang})
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN FN_GET_INSTT_NM(A.COMPNY_INSTT_SEQ, #{lang})
			ELSE NULL 
		END ) AS COMPNY_INSTT_NM,
		( CASE 
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT MNGER_NM FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_MNGER_NM FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
			ELSE NULL 
		END ) AS MNGER_NM,
		( CASE 
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT MNGER_TEL FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_OFFICE_TEL FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
			ELSE NULL 
		END ) AS TEL,
		( CASE 
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT MNGER_EMAIL FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_EMAIL FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
			ELSE NULL 
		END ) AS EMAIL
		
	</sql>
	
	<sql id="whereBoothReqMng">
		AND A.FAIR_SEQ = #{fairSeq}
		
		<!-- 검색어 -->
		<if test="@org.apache.commons.lang.StringUtils@isNotBlank(searchKeyword) and @org.apache.commons.lang.StringUtils@isNotBlank(searchValue)" >
			<choose>
				<when test="searchKeyword == 'SDC0000000005'">
					AND A.MNGER_NM LIKE CONCAT('%', #{searchValue}, '%')
				</when>				
				<when test="searchKeyword == 'SDC0000000007'">
					AND A.COMPNY_INSTT_NM LIKE CONCAT('%', #{searchValue}, '%')
				</when>
				<when test="searchKeyword == 'SDC0000000009'">
					AND A.TEL = #{searchValue}
				</when>
			</choose>
		</if>
		
		<!-- 예약상태  -->
		<if test="@org.apache.commons.lang.StringUtils@isNotBlank(boothStsCd)">AND A.BOOTH_STS_CD = #{boothStsCd}</if>
		
	</sql>
	
	<select id="selectBoothReqMngTotalCount" parameterType="FairBoothMngBean" resultType="java.lang.Integer" >
	<!-- 채용행사 부스 참가현황 조회 갯수 -->
		SELECT
			COUNT(*) AS totalCount
		FROM (
			SELECT 
				* 
			FROM (	
				SELECT 
					<include refid="selectBoothReqMngColumn"/>
				FROM
					CPES_FAIR_BOOTH A
			) A			
			<where>
				<include refid="whereBoothReqMng"/>
			</where>
		) T
	</select>
	
	<select id="selectBoothReqMngList" parameterType="FairBoothMngBean" resultType="FairBoothMngBean" >
	<!-- 채용행사 부스 참가현황 조회 리스트 -->
		SELECT 
			${totalCount} - ((${pageNo} - 1) * ${length}) - (@rownum:=@rownum+1) + 1 AS ROW_NUM,
			T.* 
		FROM (	
				SELECT 
					* 
				FROM (	
					SELECT 
						<include refid="selectBoothReqMngColumn"/>
					FROM
						CPES_FAIR_BOOTH A
				) A
				JOIN
					(SELECT @ROWNUM := 0 AS ROW_NUM) E
				<where>
					<include refid="whereBoothReqMng"/>
				</where>
				<choose>
					<when test="@org.apache.commons.lang.StringUtils@isNotBlank(orderColumn)">
						ORDER BY ${orderColumn} ${orderColumnSort}
	               	</when>
					<otherwise>
						ORDER BY A.REG_DT DESC
					</otherwise>
				</choose>
				<if test="length > -1">
				LIMIT 
					${start} , ${length}				
				</if>
		) T		
	</select>
	
	
	<select id="selectBoothReqMngDetail" parameterType="FairBoothMngBean" resultType="FairBoothMngBean" >
	<!-- 채용행사 부스 참가현황 조회 상세 -->
		SELECT 
			* 
		FROM (	
			SELECT 
				<include refid="selectBoothReqMngColumn"/>
			FROM
				CPES_FAIR_BOOTH A
			) A
		<where>
			AND A.FAIR_SEQ = #{fairSeq}
			AND A.BOOTH_SEQ = #{boothSeq}
		</where>
	</select>	
	
	<sql id="selectBoothResvMngColumn">
		A.FAIR_BOOTH_WAIT_SEQ,
		A.FAIR_SEQ,
		A.COMPNY_INSTT_SEQ,
		A.COMPNY_INSTT_DIV_CD,
		A.DEL_YN,
		A.REG_USER_SEQ,
		A.REG_DT,
		B.BOOTH_NM,
		B.BOOTH_FEE,
		B.BOOTH_REQ_DT,
		B.BOOTH_CANCEL_REQ_DT,
		B.BOOTH_STS_CD,
		B.USE_YN,
		( CASE 
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN FN_GET_COMPNY_NM(A.COMPNY_INSTT_SEQ, #{lang})
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN FN_GET_INSTT_NM(A.COMPNY_INSTT_SEQ, #{lang})
			ELSE NULL 
		END ) AS COMPNY_INSTT_NM,
		( CASE 
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT MNGER_NM FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_MNGER_NM FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
			ELSE NULL 
		END ) AS MNGER_NM,
		( CASE 
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT MNGER_TEL FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_OFFICE_TEL FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
			ELSE NULL 
		END ) AS TEL,
		( CASE 
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT MNGER_EMAIL FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
			WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_EMAIL FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
			ELSE NULL 
		END ) AS EMAIL
	</sql>
	
	<sql id="whereBoothResvMng">
		AND A.FAIR_SEQ = #{fairSeq}
		AND IFNULL(A.DEL_YN, 'N') != 'Y' 
		
		<!-- 검색어 -->
		<if test="@org.apache.commons.lang.StringUtils@isNotBlank(searchKeyword) and @org.apache.commons.lang.StringUtils@isNotBlank(searchValue)" >
			<choose>
				<when test="searchKeyword == 'SDC0000000005'">
					AND A.MNGER_NM LIKE CONCAT('%', #{searchValue}, '%')
				</when>				
				<when test="searchKeyword == 'SDC0000000007'">
					AND A.COMPNY_INSTT_NM LIKE CONCAT('%', #{searchValue}, '%')
				</when>
				<when test="searchKeyword == 'SDC0000000009'">
					AND A.TEL = #{searchValue}
				</when>
			</choose>
		</if>
	</sql>

	<select id="selectBoothResvMngTotalCount" parameterType="FairBoothMngBean" resultType="java.lang.Integer" >
	<!-- 채용행사 부스 예비 신청 조회 갯수 -->
		SELECT
			COUNT(*) AS totalCount
		FROM (
			SELECT 
				* 
			FROM (	
				SELECT 
					<include refid="selectBoothResvMngColumn"/>
				FROM
					CPES_FAIR_BOOTH_WAIT_REQ A
				LEFT JOIN 
					CPES_FAIR_BOOTH B 
				ON
					A.COMPNY_INSTT_SEQ = B.COMPNY_INSTT_SEQ				
			) A			
			<where>
				<include refid="whereBoothResvMng"/>
			</where>
		) T
	</select>
	
	<select id="selectBoothResvMngList" parameterType="FairBoothMngBean" resultType="FairBoothMngBean" >
	<!-- 채용행사 부스 참가현황 조회 리스트 -->
		SELECT 
			${totalCount} - ((${pageNo} - 1) * ${length}) - (@rownum:=@rownum+1) + 1 AS ROW_NUM,
			T.* 
		FROM (	
				SELECT 
					* 
				FROM (	
					SELECT 
						<include refid="selectBoothResvMngColumn"/>
					FROM
						CPES_FAIR_BOOTH_WAIT_REQ A
					LEFT JOIN 
						CPES_FAIR_BOOTH B 
					ON
						A.COMPNY_INSTT_SEQ = B.COMPNY_INSTT_SEQ				
				) A
				JOIN
					(SELECT @ROWNUM := 0 AS ROW_NUM) E
				<where>
					<include refid="whereBoothResvMng"/>
				</where>
				<choose>
					<when test="@org.apache.commons.lang.StringUtils@isNotBlank(orderColumn)">
						ORDER BY ${orderColumn} ${orderColumnSort}
	               	</when>
					<otherwise>
						ORDER BY A.REG_DT DESC
					</otherwise>
				</choose>
				<if test="length > -1">
				LIMIT 
					${start} , ${length}				
				</if>
		) T		
	</select>


	<select id="selectBoothReqListLayerA" parameterType="FairBoothMngBean" resultType="FairBoothMngBean" >
	<!-- 채용행사 부스 관리 - 기업/기관 선택 팝업 예비신청 조회 리스트 -->
		SELECT
			T.COMPNY_INSTT_SEQ,
			T.COMPNY_INSTT_DIV_CD,
			T.COMPNY_INSTT_NM,
			T.REG_NUM,
			T.MNGER_NM,
			T.TEL,
			T.EMAIL
		FROM (
			SELECT 
				A.COMPNY_INSTT_SEQ,
				A.COMPNY_INSTT_DIV_CD,
				( CASE 
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN FN_GET_COMPNY_NM(A.COMPNY_INSTT_SEQ, #{lang})
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN FN_GET_INSTT_NM(A.COMPNY_INSTT_SEQ, #{lang})
				END ) AS COMPNY_INSTT_NM,
				( CASE 
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT REG_NUM FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_REG_NUM FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
				END ) AS REG_NUM,
				( CASE 
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT MNGER_NM FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_MNGER_NM FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
				END ) AS MNGER_NM,
				( CASE 
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT MNGER_TEL FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_OFFICE_TEL FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
				END ) AS TEL,
				( CASE 
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000001' THEN (SELECT MNGER_EMAIL FROM CPES_COMPNY WHERE COMPNY_SEQ = A.COMPNY_INSTT_SEQ)
					WHEN A.COMPNY_INSTT_DIV_CD = 'CID0000000002' THEN (SELECT INSTT_EMAIL FROM CPES_INSTT WHERE INSTT_SEQ = A.COMPNY_INSTT_SEQ)
				END ) AS EMAIL
			FROM
				CPES_FAIR_BOOTH_WAIT_REQ A
			WHERE
				A.FAIR_SEQ = #{fairSeq}
			AND 
				IFNULL(A.COMPNY_INSTT_SEQ, 'NULL') != 'NULL'
			GROUP BY COMPNY_INSTT_SEQ
		) T
		<where>
			<!-- 검색어 -->
			<if test="@org.apache.commons.lang.StringUtils@isNotBlank(searchKeyword) and @org.apache.commons.lang.StringUtils@isNotBlank(searchValue)" >
				<choose>
					<when test="searchKeyword == 'SDC0000000002'">
						AND EMAIL = #{searchValue}
					</when>				
					<when test="searchKeyword == 'SDC0000000005'">
						AND MNGER_NM LIKE CONCAT('%', #{searchValue}, '%')
					</when>

					<when test="searchKeyword == 'SDC0000000006'">
						AND REG_NUM = #{searchValue}
					</when>				
					<when test="searchKeyword == 'SDC0000000007'">
						AND COMPNY_INSTT_NM LIKE CONCAT('%', #{searchValue}, '%')
					</when>
					<when test="searchKeyword == 'SDC0000000009'">
						AND TEL = #{searchValue}
					</when>
				</choose>
			</if>
		</where>
		ORDER BY COMPNY_INSTT_NM
	</select>

	<select id="selectBoothReqListLayerB" parameterType="FairBoothMngBean" resultType="FairBoothMngBean" >
	<!-- 채용행사 부스 관리 - 기업/기관 선택 팝업 채용행사참여 조회 리스트 -->
		SELECT 
			T.COMPNY_INSTT_SEQ,
			T.COMPNY_INSTT_DIV_CD,
			T.COMPNY_INSTT_NM,
			T.REG_NUM,
			T.MNGER_NM,
			T.TEL,
			T.EMAIL
		FROM (
			SELECT
				A.COMPNY_SEQ AS COMPNY_INSTT_SEQ,
				'CID0000000001' AS COMPNY_INSTT_DIV_CD,
				FN_GET_COMPNY_NM(A.COMPNY_SEQ, #{lang}) AS COMPNY_INSTT_NM,
				B.REG_NUM AS REG_NUM,
				B.MNGER_NM AS MNGER_NM,
				B.MNGER_TEL AS TEL,
				B.MNGER_EMAIL AS EMAIL
				
			FROM
				CPES_FAIR_PATCPTN_COMPNY A
			JOIN
				CPES_COMPNY B
			ON
				A.COMPNY_SEQ = B.COMPNY_SEQ
			WHERE 
				A.FAIR_SEQ = #{fairSeq}
			AND	
				A.JC_AGREE_STS_CD = 'JAS0000000001'
			AND	
				IFNULL(B.DEL_YN, 'N') != 'Y'
			UNION ALL
			SELECT
				A.INSTT_SEQ AS COMPNY_INSTT_SEQ,
				'CID0000000002' AS COMPNY_INSTT_DIV_CD,
				FN_GET_INSTT_NM(A.INSTT_SEQ, #{lang}) AS COMPNY_INSTT_NM,
				B.INSTT_REG_NUM AS REG_NUM,
				B.INSTT_MNGER_NM AS MNGER_NM,
				B.INSTT_OFFICE_TEL AS TEL,
				B.INSTT_EMAIL AS EMAIL
				
			FROM
				CPES_FAIR_PATCPTN_INSTT A
			JOIN
				CPES_INSTT B
			ON
				A.INSTT_SEQ = B.INSTT_SEQ
			WHERE 
				A.FAIR_SEQ = #{fairSeq}
			AND	
				A.JC_AGREE_STS_CD = 'JAS0000000001'
			AND	
				IFNULL(B.DEL_YN, 'N') != 'Y'
		) T
		<where>
			<!-- 검색어 -->
			<if test="@org.apache.commons.lang.StringUtils@isNotBlank(searchKeyword) and @org.apache.commons.lang.StringUtils@isNotBlank(searchValue)" >
				<choose>
					<when test="searchKeyword == 'SDC0000000002'">
						AND EMAIL = #{searchValue}
					</when>				
					<when test="searchKeyword == 'SDC0000000005'">
						AND MNGER_NM LIKE CONCAT('%', #{searchValue}, '%')
					</when>

					<when test="searchKeyword == 'SDC0000000006'">
						AND REG_NUM = #{searchValue}
					</when>				
					<when test="searchKeyword == 'SDC0000000007'">
						AND COMPNY_INSTT_NM LIKE CONCAT('%', #{searchValue}, '%')
					</when>
					<when test="searchKeyword == 'SDC0000000009'">
						AND TEL = #{searchValue}
					</when>
				</choose>
			</if>
		</where>
		ORDER BY COMPNY_INSTT_NM

	</select>

</mapper>
