<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fairWorkshop">

	<select id="selectFairWorkshopList" parameterType="ony.cpes.internal.fair.bean.FairWorkshopBean" resultType="ony.cpes.internal.fair.bean.FairWorkshopBean">
		/*fairWorkshop.selectFairWorkshopList*/
		SELECT ${totalCount} - ((${pageNo} - 1) * ${length}) - (@rownum:=@rownum+1) + 1 AS ROW_NUM
			 , B.FAIR_WORKSHOP_SEQ
			 , B.WORKSHOP_NM
			 , B.TUITION
			 , B.LECTURE_ROOM
			 , CONCAT(DATE_FORMAT(B.WORKSHOP_DT, '%d/%m/%Y'), ' ', B.BGN_AMPM, ' ', B.BGN_HOUR, ':', B.BGN_MINUTE,
			 	'~', B.END_AMPM, ' ', B.END_HOUR, B.END_MINUTE) AS WORKSHOP_DT
			 , B.RECURMT_MAN
			 , B.TEACHER_NM1
			 , DATE_FORMAT(B.REG_DT, '%d/%m/%Y %H:%i %p') AS REG_DT
			 , (SELECT COUNT(1) FROM CPES_FAIR_WORKSHOP_PATCPTN WHERE FAIR_SEQ = B.FAIR_SEQ AND FAIR_WORKSHOP_SEQ = B.FAIR_WORKSHOP_SEQ) AS PATCPTN_CNT
			 , FN_GET_COMMON_NM('WORKSHOP_STS_CD', B.WORKSHOP_STS_CD, #{lang}) AS WORKSHOP_STS_NM
			 , B.WORKSHOP_STS_CD
		FROM (SELECT WORKSHOP.FAIR_WORKSHOP_SEQ
				 , WORKSHOP.FAIR_SEQ
				 , WORKSHOP.WORKSHOP_NM
				 , WORKSHOP.TUITION
				 , WORKSHOP.LECTURE_ROOM
				 , WORKSHOP.WORKSHOP_DT
				 , WORKSHOP.BGN_HOUR
				 , WORKSHOP.BGN_MINUTE
				 , WORKSHOP.BGN_AMPM
				 , WORKSHOP.END_HOUR
				 , WORKSHOP.END_MINUTE
				 , WORKSHOP.END_AMPM
				 , WORKSHOP.RECURMT_MAN
				 , WORKSHOP.REG_DT
				 , WORKSHOP.TEACHER_NM1
				 , WORKSHOP.WORKSHOP_STS_CD
			FROM CPES_FAIR_WORKSHOP WORKSHOP
				JOIN (SELECT @ROWNUM := 0 AS ROW_NUM) A
			WHERE WORKSHOP.DEL_YN = 'N'
			AND WORKSHOP.FAIR_SEQ = #{fairSeq}

			<choose>
				<when test="@org.apache.commons.lang.StringUtils@isNotBlank(orderColumn)">
					ORDER BY ${orderColumn} ${orderColumnSort}
               	</when>
				<otherwise>
					ORDER BY B.REG_DT DESC
				</otherwise>
			</choose>

			<if test="length > -1">
			LIMIT
				${start} , ${length}
			</if>
			) B
	</select>

	<select id="selectFairWorkshopTotCnt" parameterType="ony.cpes.internal.fair.bean.FairWorkshopBean" resultType="int">
		/*fairWorkshop.selectFairWorkshopTotCnt*/
		SELECT COUNT(1) AS CNT
		FROM CPES_FAIR_WORKSHOP WORKSHOP
		WHERE WORKSHOP.USE_YN = 'Y'
		AND WORKSHOP.FAIR_SEQ = #{fairSeq}
	</select>

	<select id="selectWorkshopDetail" parameterType="ony.cpes.internal.fair.bean.FairWorkshopBean" resultType="ony.cpes.internal.fair.bean.FairWorkshopBean">
		/*fairWorkshop.selectWorkshopDetail*/
		SELECT WORKSHOP.FAIR_WORKSHOP_SEQ
			 , WORKSHOP.FAIR_SEQ
			 , WORKSHOP.WORKSHOP_NM
			 , WORKSHOP.EXPLN
			 , WORKSHOP.WORKSHOP_THUM_FILE_GRP_SEQ
			 , FN_GET_FILE_PATH(WORKSHOP.WORKSHOP_THUM_FILE_GRP_SEQ) AS THUM_FILE_PATH
			 , DATE_FORMAT(WORKSHOP.WORKSHOP_DT, '%d/%m/%Y') AS WORKSHOP_DT
			 , WORKSHOP.BGN_HOUR
			 , WORKSHOP.BGN_MINUTE
			 , WORKSHOP.BGN_AMPM
			 , WORKSHOP.END_HOUR
			 , WORKSHOP.END_MINUTE
			 , WORKSHOP.END_AMPM
			 , WORKSHOP.WORKSHOP_ADDR_CD
			 , WORKSHOP.WORKSHOP_ADDR_FULL_CD
			 , WORKSHOP.WORKSHOP_ADDR_FULL_NM
			 , WORKSHOP.WORKSHOP_ADDR_DTL
			 , WORKSHOP.LECTURE_ROOM
			 , WORKSHOP.TUITION_GRP_CD
			 , WORKSHOP.TUITION
			 , WORKSHOP.GOOGLE_MAP_LINK
			 , WORKSHOP.MNGER_NM
			 , WORKSHOP.MNGER_TEL
			 , WORKSHOP.MNGER_EMAIL
			 , WORKSHOP.MOD_USER_SEQ
			 , FN_GET_USER_NM_BY_USER_SEQ(WORKSHOP.MOD_USER_SEQ, #{lang}) AS MOD_USER_NM
			 , DATE_FORMAT(WORKSHOP.MOD_DT, '%d/%m/%Y %H:%i') AS MOD_DT
			 , WORKSHOP.TARGET
			 , WORKSHOP.RECURMT_MAN
			 , WORKSHOP.TEACHER_NM1
			 , WORKSHOP.TEACHER_NM2
			 , WORKSHOP.TEACHER_PHOTO1_FILE_GRP_SEQ
			 , FN_GET_FILE_PATH(WORKSHOP.TEACHER_PHOTO1_FILE_GRP_SEQ) AS TEACHER_PHOTO1_FILE_PATH
			 , WORKSHOP.TEACHER_PHOTO2_FILE_GRP_SEQ
			 , FN_GET_FILE_PATH(WORKSHOP.TEACHER_PHOTO2_FILE_GRP_SEQ) AS TEACHER_PHOTO2_FILE_PATH
			 , WORKSHOP.TEACHER_BHIST1
			 , WORKSHOP.TEACHER_BHIST2
			 , WORKSHOP.TEACH_FILE_GRP_SEQ
			 , WORKSHOP.USE_YN
			 , WORKSHOP.WORKSHOP_STS_CD
			 , (SELECT COUNT(1) FROM CPES_FAIR_WORKSHOP_PATCPTN WHERE FAIR_WORKSHOP_SEQ = WORKSHOP.FAIR_WORKSHOP_SEQ AND FAIR_SEQ = WORKSHOP.FAIR_SEQ) AS PATCPTN_CNT
		FROM CPES_FAIR_WORKSHOP WORKSHOP
		WHERE WORKSHOP.FAIR_WORKSHOP_SEQ = #{fairWorkshopSeq}
	</select>

	<select id="selectWorkshopPatcptnList" parameterType="ony.cpes.internal.fair.bean.FairWorkshopPatcptnBean" resultType="ony.cpes.internal.fair.bean.FairWorkshopPatcptnBean">
		/*fairWorkshop.selectWorkshopPatcptnList*/
		SELECT ${totalCount} - ((${pageNo} - 1) * ${length}) - (@rownum:=@rownum+1) + 1 AS ROW_NUM
			 , B.FAIR_WORKSHOP_PATCPTN_SEQ
			 , FN_GET_COMMON_NM('USER_AUTH_CD', B.USER_AUTH_CD, #{lang}) AS USER_AUTH_NM
			 , FN_GET_USER_NM_BY_USER_SEQ(B.USER_SEQ, #{lang}) AS USER_NM
			 , B.USER_EMAIL
			 , B.USER_CELL
			 , FN_GET_USER_AGE(B.BIRTH) AS USER_AGE
			 , FN_GET_COMMON_NM('GENDER_CD', B.GENDER_CD, #{lang}) AS USER_GENDER_NM
			 , DATE_FORMAT(B.REG_DT, '%d/%m/%Y %I:%i %p') AS REG_DT
			 , B.JC_AGREE_STS_CD
			 , FN_GET_USER_NM_BY_USER_SEQ(B.JC_USER_SEQ, #{lang}) AS JC_USER_NM
		FROM (SELECT FWP.FAIR_WORKSHOP_PATCPTN_SEQ
				   , US.USER_AUTH_CD
				   , US.USER_SEQ
				   , US.USER_EMAIL
				   , US.USER_CELL
				   , US.BIRTH
				   , US.GENDER_CD
				   , FWP.REG_DT
				   , FWP.JC_AGREE_STS_CD
				   , FWP.JC_USER_SEQ
			  FROM CPES_FAIR_WORKSHOP_PATCPTN FWP
				INNER JOIN CPES_USER US
				ON FWP.USER_SEQ = US.USER_SEQ
					JOIN (SELECT @ROWNUM := 0 AS ROW_NUM) A
			  WHERE FWP.FAIR_SEQ = #{fairSeq}
			  AND FWP.FAIR_WORKSHOP_SEQ = #{fairWorkshopSeq}

			  <choose>
				<when test="@org.apache.commons.lang.StringUtils@isNotBlank(orderColumn)">
					ORDER BY ${orderColumn} ${orderColumnSort}
               	</when>
				<otherwise>
					ORDER BY B.REG_DT DESC
				</otherwise>
			  </choose>

			  <if test="length > -1">
			  LIMIT
			  	${start} , ${length}
			  </if>
			  ) B
	</select>

	<select id="selectWorkshopPatcptnTotCnt" parameterType="ony.cpes.internal.fair.bean.FairWorkshopPatcptnBean" resultType="int">
		/*fairWorkshop.selectWorkshopPatcptnList*/
		SELECT COUNT(1) AS CNT
		FROM CPES_FAIR_WORKSHOP_PATCPTN FWP
			INNER JOIN CPES_USER US
			ON FWP.USER_SEQ = US.USER_SEQ
				JOIN (SELECT @ROWNUM := 0 AS ROW_NUM) A
		WHERE FWP.FAIR_SEQ = #{fairSeq}
		AND FWP.FAIR_WORKSHOP_SEQ = #{fairWorkshopSeq}
	</select>

</mapper>
