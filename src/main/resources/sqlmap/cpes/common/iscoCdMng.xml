<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="iscoCdMng">
	
	
	<select id="selectIscoCdMngList" parameterType="IscoCdMngBean" resultType="IscoCdMngBean">
			/** iscoCdMng.selectIscoCdMngList **/
						SELECT A.*
						      ,${recordsTotal} - ((${pageNo} - 1) * ${length}) - (@ROWNUM:=@ROWNUM+1) + 1 AS ROW_NUM
						FROM(
							  SELECT A.*
							  FROM(
								SELECT A.ISCO_ID
								     , A.ISCO_CD
								     , CASE WHEN #{lang} = 'kh'
								            THEN A.KH_NM
								            ELSE A.EN_NM
								            END AS CD_NM
								     , A.EN_NM
								     , A.KH_NM
								     , A.UPPER_CD
								     , A.CD_LVL
								     , FN_GET_USER_NM_BY_USER_SEQ(A.REG_USER_SEQ,#{lang}) AS REG_USER_NM
									 , FN_GET_BASE_DATE_CHAR(A.REG_DT, #{lang}) AS REG_DT
									 , A.REG_DT AS REG_DATE
								     , A.USE_YN
								     , A.LVL
								     , A.JOB_CATE_CD
								FROM CPES_ISCO_CD A
							 ) A
						<where>
							1=1
							<if test='searchValue != null and searchValue != ""'>
					            <if test='searchKeyword == "1"'> 
									AND A.CD_NM LIKE CONCAT('%',#{searchValue},'%')
								</if>
								<if test='searchKeyword == "2"'> 
									AND A.ISCO_CD LIKE CONCAT('%',#{searchValue},'%')
								</if>
								<if test='searchKeyword == "3"'> 
									AND A.REG_USER_NM LIKE CONCAT('%',#{searchValue},'%')
								</if>
							</if>
							
						</where>
						
					) A,
					
					    (SELECT @ROWNUM := 0) B
					    <choose>
				           <when test="orderColumn == 'REG_DT'">
				          	ORDER BY A.REG_DATE ${orderColumnSort}
				          </when>
				          <otherwise>
				          	ORDER BY ${orderColumn} ${orderColumnSort}
				          </otherwise>
				        </choose>
						
			        LIMIT ${start} , ${length}
	</select>
	
	<select id="selectIscoCdMngListTotalCount" parameterType="IscoCdMngBean" resultType="java.lang.Integer">
					/** iscoCdMng.selectIscoCdMngListTotalCount **/
					SELECT COUNT(*) AS totalCount 
						FROM(
							SELECT A.*
							  FROM(
								SELECT A.ISCO_ID
								     , A.ISCO_CD
								     , CASE WHEN #{lang} = 'kh'
								            THEN A.KH_NM
								            ELSE A.EN_NM
								            END AS CD_NM
								     , A.EN_NM
								     , A.KH_NM
								     , A.UPPER_CD
								     , A.CD_LVL
								     , FN_GET_USER_NM_BY_USER_SEQ(A.REG_USER_SEQ,#{lang}) AS REG_USER_NM
									 , FN_GET_BASE_DATE_CHAR(A.REG_DT, #{lang}) AS REG_DT
									 , A.REG_DT AS REG_DATE
								     , A.USE_YN
								     , A.LVL
								     , A.JOB_CATE_CD
								FROM CPES_ISCO_CD A
						) A
					<where>
						1=1
						<if test='searchValue != null and searchValue != ""'>
					            <if test='searchKeyword == "1"'> 
									AND A.CD_NM LIKE CONCAT('%',#{searchValue},'%')
								</if>
								<if test='searchKeyword == "2"'> 
									AND A.ISCO_CD LIKE CONCAT('%',#{searchValue},'%')
								</if>
								<if test='searchKeyword == "3"'> 
									AND A.REG_USER_NM LIKE CONCAT('%',#{searchValue},'%')
								</if>
							</if>
						
						<if test="useYn != null and useYn != ''">
							AND A.USE_YN = #{useYn}
						</if>
					</where>
					) A
	</select>
	
	<select id="selectIscoOneList" resultType="IscoBean" parameterType="IscoCdMngBean">
	/** iscoCdMng.selectIscoOneList **/
	
		SELECT A.ISCO_ID
		      , CASE WHEN #{lang} = 'kh'
		             THEN A.KH_NM
		             ELSE A.EN_NM
		             END  AS CATE_NM
		FROM CPES_ISCO_CD A
		WHERE A.LVL = '1' 
		  AND A.ISCO_CD NOT IN (#{iscoCd})
	</select>
	
	<select id="selectIscoTwoList" resultType="IscoBean" parameterType="IscoBean">
	/** iscoCdMng.selectIscoTwoList **/
	
		SELECT A.ISCO_ID
		      , CASE WHEN #{lang} = 'kh'
		             THEN A.KH_NM
		             ELSE A.EN_NM
		             END  AS CATE_NM
		FROM CPES_ISCO_CD A
		WHERE A.LVL = '2' 
		  AND SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-3),'=>',1) = #{iscoId}
		  AND A.ISCO_CD NOT IN (#{iscoCd})
	</select>
	
	<select id="selectIscoThreeList" resultType="IscoBean" parameterType="IscoBean">
	/** iscoCdMng.selectIscoThreeList **/
	
		SELECT A.ISCO_ID
		      , CASE WHEN #{lang} = 'kh'
		             THEN A.KH_NM
		             ELSE A.EN_NM
		             END  AS CATE_NM
		FROM CPES_ISCO_CD A
		WHERE A.LVL = '3' 
		  AND SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1) = #{iscoId}
		  AND A.ISCO_CD NOT IN (#{iscoCd})
	</select>
	
	<select id="selectIscoIdGet" resultType="java.lang.Integer">
		SELECT MAX(ISCO_ID) + 1 AS ISCO_ID
        FROM CPES_ISCO_CD 
	</select>
	
	<select id="selectIscoSeq" resultType="java.lang.String" >
		select CONCAT('IOC',LPAD(substr(IFNULL(MAX(A.ISCO_CD),0000000000),4) + 1 ,10,'0'))
        from CPES_ISCO_CD A
	</select>
	
	<select id="selectIscoCdMngDetail" resultType="IscoCdMngBean" parameterType="IscoCdMngBean">
		/** iscoCdMng.selectIscoCdMngDetail **/
				SELECT	A.ISCO_CD
				       ,A.ISCO_ID
				       ,A.CD_LVL
				       ,SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-4),'=>',1) AS ONE_DEPTH
				       ,(SELECT CASE WHEN #{lang} = 'kh'
				                    THEN T3.KH_NM
				                    ELSE T3.EN_NM
				                    END AS NM
				        FROM CPES_ISCO_CD T3 WHERE T3.ISCO_ID = SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-4),'=>',1) ) AS ONE_DEPTH_NM
				       ,CASE WHEN A.LVL = '4' 
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-3),'=>',1)
				             WHEN A.LVL = '3'
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1)
				             WHEN A.LVL = '2'
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-1),'=>',1)
				             ELSE NULL
				             END AS TWO_DEPTH
				       ,(SELECT CASE WHEN #{lang} = 'kh'
				                    THEN T3.KH_NM
				                    ELSE T3.EN_NM
				                    END AS NM
				        FROM CPES_ISCO_CD T3 WHERE T3.ISCO_ID = CASE WHEN A.LVL = '4' 
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-3),'=>',1)
														             WHEN A.LVL = '3'
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1)
														             WHEN A.LVL = '2'
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-1),'=>',1)
														             ELSE '999999999'
														             END
				        ) AS TWO_DEPTH_NM
				       ,CASE WHEN A.LVL = '4'
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1) 
				             WHEN A.LVL = '3'
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-1),'=>',1) 
				             ELSE NULL
				             END AS THREE_DEPTH
				       ,(SELECT CASE WHEN #{lang} = 'kh'
				                    THEN T3.KH_NM
				                    ELSE T3.EN_NM
				                    END AS NM
				        FROM CPES_ISCO_CD T3 WHERE T3.ISCO_ID = CASE WHEN A.LVL = '4'
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1) 
														             WHEN A.LVL = '3'
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-1),'=>',1) 
														             ELSE '999999999999'
														             END
				        ) AS THREE_DEPTH_NM
				       ,A.LVL
				       ,A.LVL AS DEPTH
				       ,A.KH_NM
				       ,A.EN_NM
				       ,A.USE_YN
				       ,A.JOB_CATE_CD
				       ,FN_GET_USER_NM_BY_USER_SEQ(A.REG_USER_SEQ,#{lang}) AS REG_USER_NM
				       ,FN_GET_BASE_DATE_CHAR(A.REG_DT,#{lang}) AS REG_DT
				FROM CPES_ISCO_CD A
				WHERE A.ISCO_CD = #{iscoCd}
	</select>
	
</mapper>
