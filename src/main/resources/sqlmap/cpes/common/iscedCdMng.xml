<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="iscedCdMng">
	
	
	<select id="selectIscedCdMngList" parameterType="IscedCdMngBean" resultType="IscedCdMngBean">
			/** iscoCdMng.selectIscoCdMngList **/
						SELECT A.*
						      ,${recordsTotal} - ((${pageNo} - 1) * ${length}) - (@ROWNUM:=@ROWNUM+1) + 1 AS ROW_NUM
						FROM(
							  SELECT A.*
							  FROM(
								SELECT A.ISCED_ID
								     , A.ISCED_CD
								     , CASE WHEN #{lang} = 'kh'
								            THEN A.KH_NM
								            ELSE A.EN_NM
								            END AS CD_NM
								     , A.EN_NM
								     , A.KH_NM								     
								     , A.CD_LVL
								     , FN_GET_USER_NM_BY_USER_SEQ(A.REG_USER_SEQ,#{lang}) AS REG_USER_NM
									 , FN_GET_BASE_DATE_CHAR(A.REG_DT, #{lang}) AS REG_DT
									 , A.REG_DT AS REG_DATE
								     , A.USE_YN
								     , A.LVL
								FROM CPES_ISCED_CD A
							 ) A
						<where>
							1=1
							<if test='searchValue != null and searchValue != ""'>
					            <if test='searchKeyword == "1"'> 
									AND A.CD_NM LIKE CONCAT('%',#{searchValue},'%')
								</if>
								<if test='searchKeyword == "2"'> 
									AND A.ISCED_CD LIKE CONCAT('%',#{searchValue},'%')
								</if>
								<if test='searchKeyword == "3"'> 
									AND A.REG_USER_NM LIKE CONCAT('%',#{searchValue},'%')
								</if>
							</if>
							
						</where>
						
					) A,
					
					    (SELECT @ROWNUM := 0) B
					    <choose>
				           <when test="orderColumn == 'REG_DT'">
				          	ORDER BY A.REG_DATE ${orderColumnSort}
				          </when>
				          <otherwise>
				          	ORDER BY ${orderColumn} ${orderColumnSort}
				          </otherwise>
				        </choose>
						
			        LIMIT ${start} , ${length}
	</select>
	
	<select id="selectIscedCdMngListTotalCount" parameterType="IscedCdMngBean" resultType="java.lang.Integer">
					/** iscoCdMng.selectIscoCdMngListTotalCount **/
					SELECT COUNT(*) AS totalCount 
						FROM(
							SELECT A.ISCED_ID
								     , A.ISCED_CD
								     , CASE WHEN #{lang} = 'kh'
								            THEN A.KH_NM
								            ELSE A.EN_NM
								            END AS CD_NM
								     , A.EN_NM
								     , A.KH_NM								     
								     , A.CD_LVL
								     , FN_GET_USER_NM_BY_USER_SEQ(A.REG_USER_SEQ,#{lang}) AS REG_USER_NM
									 , FN_GET_BASE_DATE_CHAR(A.REG_DT, #{lang}) AS REG_DT
									 , A.REG_DT AS REG_DATE
								     , A.USE_YN
								     , A.LVL
								FROM CPES_ISCED_CD A
						) A
					<where>
						1=1
						<if test='searchValue != null and searchValue != ""'>
					            <if test='searchKeyword == "1"'> 
									AND A.CD_NM LIKE CONCAT('%',#{searchValue},'%')
								</if>
								<if test='searchKeyword == "2"'> 
									AND A.ISCED_CD LIKE CONCAT('%',#{searchValue},'%')
								</if>
								<if test='searchKeyword == "3"'> 
									AND A.REG_USER_NM LIKE CONCAT('%',#{searchValue},'%')
								</if>
							</if>
						
						<if test="useYn != null and useYn != ''">
							AND A.USE_YN = #{useYn}
						</if>
					</where>
	</select>
	
	<select id="selectIscedOneList" resultType="IscedCdMngBean" parameterType="IscedCdMngBean">
	/** iscedCdMng.selectIscedOneList **/
	
		SELECT A.ISCED_ID
		     , CASE WHEN #{lang} = 'kh'
			        THEN A.KH_NM
			        ELSE A.EN_NM
			        END  AS CATE_NM
		FROM CPES_ISCED_CD A
		WHERE A.LVL = 1
		  AND A.ISCED_CD NOT IN (#{iscedCd})
	</select>
	
	<select id="selectIscedTwoList" resultType="IscedCdMngBean" parameterType="IscedCdMngBean">
	/** iscedCdMng.selectIscedTwoList **/
	
		SELECT A.ISCED_ID
		      , CASE WHEN #{lang} = 'kh'
		             THEN A.KH_NM
		             ELSE A.EN_NM
		             END  AS CATE_NM
		FROM CPES_ISCED_CD A
		WHERE A.LVL = 2
		  AND SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-3),'=>',1) = #{iscedId}
		  AND A.ISCED_CD NOT IN (#{iscedCd})
	</select>
	
	<select id="selectIscedThreeList" resultType="IscedCdMngBean" parameterType="IscedCdMngBean">
	/** iscedCdMng.selectIscedThreeList **/
	
		SELECT A.ISCED_ID
		      , CASE WHEN #{lang} = 'kh'
		             THEN A.KH_NM
		             ELSE A.EN_NM
		             END  AS CATE_NM
		FROM CPES_ISCED_CD A
		WHERE A.LVL = 3
		  AND SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1) = #{iscedId}
		  AND A.ISCED_CD NOT IN (#{iscedCd})
	</select>
	
	<select id="selectIscedIdGet" resultType="java.lang.String">
		SELECT MAX(ISCED_ID) + 1 AS ISCED_ID
        FROM CPES_ISCED_CD 
	</select>
	
	<select id="selectIscedSeq" resultType="java.lang.String" >
		select CONCAT('IDC',LPAD(substr(IFNULL(MAX(A.ISCED_CD),0000000000),4) + 1 ,10,'0'))
        from CPES_ISCED_CD A
	</select>
	
	<select id="selectIscedCdMngDetail" resultType="IscedCdMngBean" parameterType="IscedCdMngBean">
		/** iscedCdMng.selectIscedCdMngDetail **/
				SELECT	A.ISCED_CD
				       ,A.ISCED_ID
				       ,A.CD_LVL
				       ,SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-4),'=>',1) AS ONE_DEPTH
				       ,(SELECT CASE WHEN #{lang} = 'kh'
				                    THEN T3.KH_NM
				                    ELSE T3.EN_NM
				                    END AS NM
				        FROM CPES_ISCED_CD T3 WHERE T3.ISCED_ID = SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-4),'=>',1) ) AS ONE_DEPTH_NM
				       ,CASE WHEN A.LVL = '4' 
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-3),'=>',1)
				             WHEN A.LVL = '3'
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1)
				             WHEN A.LVL = '2'
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-1),'=>',1)
				             ELSE NULL
				             END AS TWO_DEPTH
				       ,(SELECT CASE WHEN #{lang} = 'kh'
				                    THEN T3.KH_NM
				                    ELSE T3.EN_NM
				                    END AS NM
				        FROM CPES_ISCED_CD T3 WHERE T3.ISCED_ID = CASE WHEN A.LVL = '4' 
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-3),'=>',1)
														             WHEN A.LVL = '3'
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1)
														             WHEN A.LVL = '2'
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-1),'=>',1)
														             ELSE '999999999'
														             END
				        ) AS TWO_DEPTH_NM
				       ,CASE WHEN A.LVL = '4'
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1) 
				             WHEN A.LVL = '3'
				             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-1),'=>',1) 
				             ELSE NULL
				             END AS THREE_DEPTH
				       ,(SELECT CASE WHEN #{lang} = 'kh'
				                    THEN T3.KH_NM
				                    ELSE T3.EN_NM
				                    END AS NM
				        FROM CPES_ISCED_CD T3 WHERE T3.ISCED_ID = CASE WHEN A.LVL = '4'
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1) 
														             WHEN A.LVL = '3'
														             THEN SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-1),'=>',1) 
														             ELSE '999999999999'
														             END
				        ) AS THREE_DEPTH_NM
				       ,A.LVL
				       ,A.LVL AS DEPTH
				       ,A.KH_NM
				       ,A.EN_NM
				       ,A.USE_YN
				       ,FN_GET_USER_NM_BY_USER_SEQ(A.REG_USER_SEQ,#{lang}) AS REG_USER_NM
				       ,FN_GET_BASE_DATE_CHAR(A.REG_DT,#{lang}) AS REG_DT
				FROM CPES_ISCED_CD A
				WHERE A.ISCED_CD = #{iscedCd}
	</select>
	
</mapper>
