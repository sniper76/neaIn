<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="program">
	
	<select id="selectProgramMngList" parameterType="ProgramBean" resultType="ProgramBean">
		/** menu.selectProgramMngList **/
		SELECT
			${totalCount} - ((${pageNo} - 1) * ${length}) - (@rownum:=@rownum+1) + 1 AS ROW_NUM
			, M.PROGRAM_SEQ
            , M.PROGRAM_ID
            , M.PROGRAM_NM
            , M.PROGRAM_URL
            , M.RANGE_CD
            , M.USE_YN
            , M.USER_NM
            , FN_GET_BASE_DATE_CHAR(M.REG_DT, 'ko') AS REG_DT
            , M.MOD_USER_SEQ
            , M.MOD_DT
			FROM (
				SELECT
		        	A.PROGRAM_SEQ
		        	, A.PROGRAM_ID
		        	<choose>
				  	<when test="lang == 'kh'">
				  	, A.PROGRAM_NM_KH AS PROGRAM_NM
				  	</when>
				  	<otherwise>
				  	, A.PROGRAM_NM_EN AS PROGRAM_NM
				  	</otherwise>
				  	</choose>
		        	, A.PROGRAM_URL
		        	, A.RANGE_CD
		        	, A.USE_YN
		        	, (SELECT 
		        		<choose>
				  		<when test="lang == 'kh'">
		        			B.USER_NM_KH
		        		</when>
					  	<otherwise>
					  		B.USER_NM_EN
					  	</otherwise>
					  	</choose>
		        	   FROM CPES_USER B WHERE B.USER_SEQ = A.REG_USER_SEQ) AS USER_NM
		        	, A.REG_DT
		        	, A.MOD_USER_SEQ
		        	, FN_GET_BASE_DATE_CHAR(A.MOD_DT, #{lang}) AS MOD_DT
		        FROM CPES_PROGRAM A
		        ,(SELECT @ROWNUM := 0) C
		       WHERE RANGE_CD = #{rangeCd}
		       		<if test="@org.apache.commons.lang.StringUtils@isNotBlank(useYn)">
		       		AND USE_YN = #{useYn}
		       		</if>
		       		<if test="@org.apache.commons.lang.StringUtils@isNotBlank(searchValue)">
		       			<choose>
		       				<when test="searchKeyword == 'SFP0000000001'">
		       					AND PROGRAM_NM_KH LIKE CONCAT('%', #{searchValue}, '%')
		       				</when>
		       				<when test="searchKeyword == 'SFP0000000002'">
		       					AND PROGRAM_NM_EN LIKE CONCAT('%', #{searchValue}, '%')
		       				</when>
		       				<when test="searchKeyword == 'SFP0000000003'">
		       					AND PROGRAM_URL LIKE CONCAT('%', #{searchValue}, '%')
		       				</when>
		       			</choose>
		       		</if>
		       		<choose>
				 	<when test="@org.apache.commons.lang.StringUtils@isNotBlank(orderColumn)">
					ORDER BY ${orderColumn} ${orderColumnSort}
					</when>
					<otherwise>
					ORDER BY A.REG_DT DESC
					</otherwise>
					</choose>
					LIMIT ${start} , ${length}
				) M
	</select>

	<select id="selectProgramMngListTotalCount" parameterType="ProgramBean" resultType="int">
		/** program.selectProgramMngListTotalCount **/
		SELECT 
			COUNT(1)
		FROM CPES_PROGRAM
	   WHERE RANGE_CD = #{rangeCd}
	   		<if test="@org.apache.commons.lang.StringUtils@isNotBlank(useYn)">
       		AND USE_YN = #{useYn}
       		</if>
       		<if test="@org.apache.commons.lang.StringUtils@isNotBlank(searchValue)">
       			<choose>
       				<when test="searchKeyword == 'SFP0000000001'">
       					AND PROGRAM_NM_KH LIKE CONCAT('%', #{searchValue}, '%')
       				</when>
       				<otherwise>
       					AND PROGRAM_NM_EN LIKE CONCAT('%', #{searchValue}, '%')
       				</otherwise>
       			</choose>
       		</if>
	</select>
	
	<select id="selectProgramId" resultType="String">
		/** program.selectProgramId **/
		SELECT IFNULL(CONCAT('PGM',LPAD(SUBSTR(MAX(PROGRAM_ID),4,10) + 1,10,'0')),'PGM0000000001') AS PROGRAM_ID FROM CPES_PROGRAM;
	</select>
	
	
	<select id="selectProgramMngDetail" parameterType="ProgramBean" resultType="ProgramBean">
		/** menu.selectProgramMngDetail **/
				SELECT
		        	A.PROGRAM_SEQ
		        	, A.PROGRAM_ID
				  	, A.PROGRAM_NM_KH
				  	, A.PROGRAM_NM_EN
		        	, A.PROGRAM_URL
		        	, A.RANGE_CD
		        	, A.USE_YN
		        	, (SELECT 
		        		<choose>
				  		<when test="lang == 'kh'">
		        			B.USER_NM_KH
		        		</when>
					  	<otherwise>
					  		B.USER_NM_EN
					  	</otherwise>
					  	</choose>
		        	   FROM CPES_USER B WHERE B.USER_SEQ = A.REG_USER_SEQ) AS REG_NM
		        	, FN_GET_BASE_DATE_CHAR(A.REG_DT, #{lang}) AS REG_DT
		        	, A.MOD_USER_SEQ
		        	, FN_GET_BASE_DATE_CHAR(A.MOD_DT, #{lang}) AS MOD_DT
		        FROM CPES_PROGRAM A
		        <where>
		        	<if test="programSeq != null and programSeq != ''">
		        	A.PROGRAM_SEQ = #{programSeq}
		        	</if>
		        	<if test="programUrl != null and programUrl != ''">
		        	AND A.PROGRAM_URL = #{programUrl}
		        	</if>
		        </where>
		       
	</select>
	
</mapper>
