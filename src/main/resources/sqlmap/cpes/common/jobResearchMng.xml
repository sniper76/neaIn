<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jobResearchMng">
	
	
	<select id="selectJobReschMngList" parameterType="JobResearchMngBean" resultType="JobResearchMngBean">
				SELECT A.*
				      ,${recordsTotal} - ((${pageNo} - 1) * ${length}) - (@ROWNUM:=@ROWNUM+1) + 1 AS ROW_NUM
				FROM(		
						SELECT A.*
						FROM(
							SELECT  (SELECT CASE WHEN #{lang} = 'kh'
							                    THEN KH_NM
							                    ELSE EN_NM
							                    END
								    FROM CPES_ISCO_CD WHERE ISCO_ID = SUBSTRING_INDEX(A.CD_LVL,'=>',1)) AS ONE_DEPTH
							      ,(SELECT CASE WHEN #{lang} = 'kh'
							                    THEN KH_NM
							                    ELSE EN_NM
							                    END
							        FROM CPES_ISCO_CD WHERE ISCO_ID = SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-3),'=>',1)) AS TWO_DEPTH
							      ,(SELECT CASE WHEN #{lang} = 'kh'
							                    THEN KH_NM
							                    ELSE EN_NM
							                    END
							        FROM CPES_ISCO_CD WHERE ISCO_ID = SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1)) AS THREE_DEPTH
								      , CASE WHEN #{lang} = 'kh'
								             THEN A.KH_NM
								             ELSE A.EN_NM
								             END AS FOUR_DEPTH
								      , CASE WHEN #{lang} = 'kh'
								             THEN A.DEF_KH
								             ELSE A.DEF_EN
								             END AS DEFINI_NM
								      , A.ISCO_CD
								      , A.CD_LVL
								      , A.USE_YN
								      , FN_GET_USER_NM_BY_USER_SEQ(A.REG_USER_SEQ,#{lang}) AS REG_USER_NM
								      , FN_GET_BASE_DATE_CHAR(A.REG_DT, #{lang}) AS REG_DT
								      , A.REG_DT AS REG_DATE
								FROM CPES_ISCO_CD A
								WHERE A.LVL = '4'
						) A
					<where>
						1=1
						<if test='searchValue != null and searchValue != ""'>
				            <if test='searchKeyword == "1"'> 
								AND A.FOUR_DEPTH LIKE CONCAT('%',#{searchValue},'%')
							</if>
							<if test='searchKeyword == "2"'> 
								AND A.DEFINI_NM LIKE CONCAT('%',#{searchValue},'%')
							</if>
							<if test='searchKeyword == "3"'> 
								AND A.ISCO_CD LIKE CONCAT('%',#{searchValue},'%')
							</if>
						</if>
						
						<if test="useYn != null and useYn != ''">
							AND A.USE_YN = #{useYn}
						</if>
						<if test="iscoId != null and iscoId != ''">
							AND SUBSTRING_INDEX(A.CD_LVL,'=',1) = #{iscoId}
						</if>
					</where>
			    ) A,
			    (SELECT @ROWNUM := 0) B
				<choose>
		           <when test="orderColumn == 'REG_DT'">
		          	ORDER BY A.REG_DATE ${orderColumnSort}
		          </when>
		          <otherwise>
		          	ORDER BY ${orderColumn} ${orderColumnSort}
		          </otherwise>
		        </choose>
	        LIMIT ${start} , ${length}
	</select>
	
	<select id="selectJobReschMngListTotalCount" parameterType="JobResearchMngBean" resultType="java.lang.Integer">
					SELECT COUNT(*) AS totalCount 
						FROM(
							SELECT  (SELECT CASE WHEN #{lang} = 'kh'
							                    THEN KH_NM
							                    ELSE EN_NM
							                    END
								    FROM CPES_ISCO_CD WHERE ISCO_ID = SUBSTRING_INDEX(A.CD_LVL,'=>',1)) AS ONE_DEPTH
							      ,(SELECT CASE WHEN #{lang} = 'kh'
							                    THEN KH_NM
							                    ELSE EN_NM
							                    END
							        FROM CPES_ISCO_CD WHERE ISCO_ID = SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-3),'=>',1)) AS TWO_DEPTH
							      ,(SELECT CASE WHEN #{lang} = 'kh'
							                    THEN KH_NM
							                    ELSE EN_NM
							                    END
							        FROM CPES_ISCO_CD WHERE ISCO_ID = SUBSTRING_INDEX(SUBSTRING_INDEX(A.CD_LVL,'=>',-2),'=>',1)) AS THREE_DEPTH
								      , CASE WHEN #{lang} = 'kh'
								             THEN A.KH_NM
								             ELSE A.EN_NM
								             END AS FOUR_DEPTH
								      , CASE WHEN #{lang} = 'kh'
								             THEN A.DEF_KH
								             ELSE A.DEF_EN
								             END AS DEFINI_NM
								      , A.ISCO_CD
								      , A.CD_LVL
								      , A.USE_YN
								      , FN_GET_USER_NM_BY_USER_SEQ(A.REG_USER_SEQ,#{lang}) AS REG_USER_NM
								      , FN_GET_BASE_DATE_CHAR(A.REG_DT, #{lang}) AS REG_DT
								      , A.REG_DT AS REG_DATE
								FROM CPES_ISCO_CD A
								WHERE A.LVL = '4'
						) A
					<where>
						1=1
						<if test='searchValue != null and searchValue != ""'>
				            <if test='searchKeyword == "1"'> 
								AND A.FOUR_DEPTH LIKE CONCAT('%',#{searchValue},'%')
							</if>
							<if test='searchKeyword == "2"'> 
								AND A.DEFINI_NM LIKE CONCAT('%',#{searchValue},'%')
							</if>
							<if test='searchKeyword == "3"'> 
								AND A.ISCO_CD LIKE CONCAT('%',#{searchValue},'%')
							</if>
						</if>
						
						<if test="useYn != null and useYn != ''">
							AND A.USE_YN = #{useYn}
						</if>
						<if test="iscoId != null and iscoId != ''">
							AND SUBSTRING_INDEX(A.CD_LVL,'=',1) = #{iscoId}
						</if>
					</where>
	</select>
	
	
	
	<select id="selectCateOneList" parameterType="JobResearchMngBean" resultType="JobResearchMngBean">
	/** jobResearchMng.selectCateOneList **/
	
		SELECT A.ISCO_ID
		      , CASE WHEN #{lang} = 'kh'
		             THEN A.KH_NM
		             ELSE A.EN_NM
		             END  AS cateNm
		FROM CPES_ISCO_CD A
		WHERE A.LVL = '1' 
	</select>
	
	
	
	<select id="selectJobReschMngDtl" parameterType="JobResearchMngBean" resultType="JobResearchMngBean">
		SELECT ISCO_ID
		     , ISCO_CD
		     , EN_NM
		     , KH_NM
		     , UPPER_CD
		     , CD_LVL
		     , REG_USER_SEQ
		     , FN_GET_USER_NM_BY_USER_SEQ(REG_USER_SEQ,#{lang}) AS REG_USER_NM
		     , FN_GET_BASE_DATE_CHAR(REG_DT, #{lang}) AS REG_DT
		     , MOD_USER_SEQ
		     , MOD_DT
		     , USE_YN
		     , LVL
		     , EXPLN
		     , CATE_NM
		     , OCCUP_INC_KH
		     , OCCUP_INC_EN
		     , OCCUP_EXC_KH
		     , OCCUP_EXC_EN
		     , NOTE_KH
		     , NOTE_EN
		     , DEF_EN
		     , DEF_KH
		     , TASK_EN
		     , TASK_KH
		     , JOB_CATE_CD
		FROM CPES_ISCO_CD
		WHERE ISCO_CD = #{iscoCd}
		
	</select>
	
</mapper>
